{% load static %}
{% load custom_tags %}
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>View Tasks</title>
  <link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}">
  <script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>
</head>
<body class="bg-light">

<div class="container mt-5">
  <h2 class="text-center mb-4 text-primary">Your Assigned Tasks</h2>

  {% if tasks %}
    <div class="row">
      {% for task in tasks %}
        <div class="col-md-6 mb-4">
          <div class="card shadow-sm">
            <div class="card-body">
              <h5 class="card-title">{{ task.title }}</h5>
              <p class="card-text">{{ task.description|default:"No description provided." }}</p>
              <p class="card-text"><strong>Due:</strong> {{ task.due_date }}</p>

              <p><strong>Assigned To:</strong>
                {% for user in task.assigned_to.all %}
                  {{ user.username }}{% if not forloop.last %}, {% endif %}
                {% endfor %}
              </p>

              <!-- Debug line (optional, can remove) -->
              <pre style="color: red;">{{ submissions_by_task|get_item:task.id }}</pre>

              {% if task.is_completed %}
                <p class="text-success">✅ Task marked as completed.</p>
              {% else %}
                {% if user.role == 'STAFF' or user.role == 'ADMIN' %}
                  <form method="POST" action="{% url 'mark_task_done' task.id %}">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-success btn-sm mb-2">Mark as Done</button>
                  </form>
                {% else %}
                  <span class="text-muted">⏳ Waiting to complete...</span>
                {% endif %}
              {% endif %}

              <hr>

              {% if user.role == 'STUDENT' %}
                {% with submissions=submissions_by_task|get_item:task.id %}
                  {% if submissions %}
                    {% for submission in submissions %}
                      {% if submission.student == user %}
                        <p><strong>Submitted by:</strong> {{ submission.student.username }}</p>
                        <a href="{{ submission.file.url }}" target="_blank" class="btn btn-outline-info btn-sm mt-2">📄 View Submitted File</a>
                        <a href="{{ submission.file.url }}" download class="btn btn-outline-secondary btn-sm mt-2">⬇ Download</a>
                        <hr>
                      {% endif %}
                    {% endfor %}
                  {% else %}
                    <a href="{% url 'upload_file' task.id %}" class="btn btn-primary btn-sm mt-2">📤 Upload File</a>
                  {% endif %}
                {% endwith %}
              {% elif user.role == 'STAFF' or user.role == 'ADMIN' %}
                {% with submissions=submissions_by_task|get_item:task.id %}
                  {% if submissions %}
                    {% for submission in submissions %}
                      <p><strong>{{ submission.student.username }} submitted:</strong></p>
                      <a href="{{ submission.file.url }}" target="_blank" class="btn btn-outline-info btn-sm mt-2">📄 View</a>
                      <a href="{{ submission.file.url }}" download class="btn btn-outline-secondary btn-sm mt-2">⬇ Download</a>
                      <hr>
                    {% endfor %}
                  {% else %}
                    <p class="text-muted">No submissions yet.</p>
                  {% endif %}
                {% endwith %}
              {% endif %}

            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="alert alert-info text-center">No tasks found.</div>
  {% endif %}
</div>

</body>
</html>
